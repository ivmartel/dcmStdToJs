class e{parseNode(e,n){const o=e.querySelector("book");if(!o)throw new Error("No book node.");const r=o.getAttribute("label");if(!r)throw new Error("No book label.");const s=o.querySelector("subtitle");if(!s)throw new Error("No book subtitle.");const c="DICOM "+r;if(!s.innerHTML.startsWith(c))throw new Error("Missing DICOM standard version prefix.");const a=s.innerHTML.indexOf("-"),u=s.innerHTML.substring(c.length,a).trim(),d={year:parseInt(u.substring(0,4),10),letter:u.substring(4)};let f=null;if("PS3.3"===r)f=function(e,n){const o=[],r=[{name:"CT Image",label:"table_A.3-1"},{name:"MR Image",label:"table_A.4-1"}];for(const s of r){const r=/M|C/g;let l=null;void 0!==s.fgLabel&&(l=v(x(e.querySelector(t(s.fgLabel)),e,s.name+" Functional Group Macros",r),e));const i=T(v(x(e.querySelector(t(s.label)),e,s.name+" IOD Modules",r),e,l),/1|1C/g);o.push({name:s.name+" IOD Modules",origin:n,raw:i,data:JSON.stringify(i,null,"  ")})}return o}(e,n);else if("PS3.5"===r)f=function(e,n,o){const r=function(e){const t=l(e,"DICOM Value Representations",void 0),n={},o=[h,p,w,y,b,E];for(const e of t){const t=e[0][0],r=e[1][0];let s;for(const e of o)if(s=e(r),void 0!==s)break;void 0===s&&console.log("Unknown VR type for "+t),n[t]=s}return n}(e.querySelector(t("table_6.2-1"))),s=Object.keys(r);for(let e=0;e<s.length;++e)void 0===r[s[e]]&&(r[s[e]]=null);const c={name:"VRs",origin:n,raw:r,data:JSON.stringify(r,null,"  ")};let a=!0;(o.year>2019||2019===o.year&&o.letter>="e")&&(a=!1);let u="table_7.1-2";a&&(u="table_7.1-1");const d=function(e){if(!e)throw new Error("No Vr caption node.");i(e,"Data Element with Explicit VR",!1);const t=e.getElementsByTagName("caption")[0].innerHTML.matchAll(/(?:\s)([A-Z]{2})(?:,|\sor|\sand|$)/g),n=[];for(const e of t)n.push(e[1]);return n}(e.querySelector(t(u)));let f=d;a||(f=s.filter((function(e){return!d.includes(e)})));const g={name:"32-bit VL VRs",origin:n,raw:f,data:JSON.stringify(f)},m=function(e){if(!e)throw new Error("No char Vr node.");const t=[],n=/(?:\s)([A-Z]{2})(?:\s\(\w+\s\w+\))/g,o=e.getElementsByTagName("para");for(const e of o)if(e.innerHTML.startsWith("For Data Elements with Value Representations")){const o=e.innerHTML.matchAll(n);for(const e of o)t.push(e[1])}return t}(e.querySelector(t("sect_6.1.2.2")));return[c,g,{name:"Character Set VRs",origin:n,raw:m,data:JSON.stringify(m)}]}(e,n,d);else if("PS3.6"===r)f=function(e,n){let o=[];o=o.concat(g(e.querySelector(t("table_7-1")),e,"Registry of DICOM File Meta Elements")),o=o.concat(g(e.querySelector(t("table_8-1")),e,"Registry of DICOM Directory Structuring Elements")),o=o.concat(g(e.querySelector(t("table_6-1")),e,"Registry of DICOM Data Elements"));const r={name:"DICOM Tags",origin:n,raw:o,data:D(A(o))},s=m(e.querySelector(t("table_A-1")),e,"UID Values","Transfer Syntax"),l={name:"Transfer syntax UIDs",origin:n,raw:s,data:JSON.stringify(k(s),null,"  ")},i=m(e.querySelector(t("table_A-1")),e,"UID Values","SOP");return[r,l,{name:"SOP class and instance UIDs",origin:n,raw:i,data:JSON.stringify(k(i),null,"  ")}]}(e,n);else{if("PS3.7"!==r)throw new Error("Unknown book label: "+r);f=function(e,n){let o=[];return o=o.concat(g(e.querySelector(t("table_E.1-1")),e,"Command Fields")),o=o.concat(g(e.querySelector(t("table_E.2-1")),e,"Retired Command Fields")),{name:"DICOM tags group 0000",origin:n,raw:o,data:D(A(o))}}(e,n)}return f}}function t(e){let t="";if(e.startsWith("table_"))t="table[label='"+e.substring(6);else{if(!e.startsWith("sect_"))throw new Error("Unknown xml:id format.");t="section[label='"+e.substring(5)}return t+"']"}function n(e){const t=[...e.matchAll(/linkend="(.+?)"/g)];if(0===t.length||2!==t[0].length)throw new Error("Cannot find linkend value in: "+e);return t[0][1]}function o(e){const t={str:e},n=e.indexOf("enum=");if(-1!==n){const o=e.indexOf(";");if(-1===o)throw new Error("Badly formed enum");const r=e.substring(0,n)+e.substring(o,e.length-1);t.str=r.trim(),t.enum=e.substring(n+5,o).split(",")}return t}function r(e){const t={str:e},n=e.indexOf("Required if");if(-1!==n){let o=!1;const r=/Required if ([\w\s]+) (\([\dA-F]{4},[\dA-F]{4}\)) ([\w\s]+)\./g,s=[...e.matchAll(r)];0!==s.length&&4===s[0].length&&("is present"===s[0][3]||"is not present"===s[0][3]||s[0][3].startsWith("has a value")||s[0][3].startsWith("is"))&&(o=!0,t.condition=s[0].slice(1),t.str=e.replace(s[0][0],"")),o||(t.condition=e.substring(n),t.str=e.substring(0,n))}return t}function s(e){return function(t,n){return t[e]<n[e]?-1:t[e]>n[e]?1:0}}function l(e,t,n){if(!e)throw new Error("No table node.");void 0!==n&&i(e,n);const o=[],r=e.querySelectorAll("tbody > tr");if(r)for(const e of r)o.push(c(e,t));return o}function i(e,t,n){void 0===n&&(n=!0);const o=e.getElementsByTagName("caption");if(!o)throw new Error("No node caption.");if(0===o.length)throw new Error("Empty node caption.");const r=o[0].innerHTML;if(n){if(r!==t){if(r.toLowerCase()!==t.toLowerCase())throw new Error("The node caption is not the expected one: "+t+" != "+r);console.warn("Accepting caption with different case: "+t)}}else if(!r.includes(t))throw new Error("The node caption does not include the expected one: "+t+" != "+r)}function c(e,t){const n=[],o=e.querySelectorAll("td");if(o)for(const e of o)n.push(a(e,t));return n}function a(e,t){const n=[],o=e.childNodes;if(o)for(const e of o)1===e.nodeType&&("variablelist"===e.nodeName?n.push(d(e)):n.push(u(e,t)));return n}function u(e,o){let r="";const s=e.childNodes;if(s)for(const e of s)1===e.nodeType?"xref"===e.nodeName?r+='linkend="'+e.attributes.linkend.value+'"':r+=u(e,o):3===e.nodeType?r+=e.textContent:console.warn("Un-anticipated node:"+e);r=f(r);const l=r.match(/See linkend=.+ for Defined Terms\./g);if(l&&1===l.length){let e=!1;const s=n(r);if(s.startsWith("sect_")){const n=o.querySelector(t(s)).childNodes;if(n)for(const t of n)"variablelist"===t.nodeName&&(e?console.warn("Multiple variable list for "+s):(e=!0,r=r.replace(l[0],d(t))))}e||console.warn("Did not find terms list with: "+r)}return r}function d(e){let t="enum=";const n=e.childNodes;if(n)for(const e of n)if("varlistentry"===e.nodeName){const n=e.childNodes;if(n)for(const e of n)"term"===e.nodeName&&(t+=f(e.textContent)+",")}return t.replace(/,$/,";")}function f(e){return e.trim().replace(/\n/g,"").replace(/\u200B/g,"")}function g(e,t,n){const o=l(e,t,n),r=[];let s=null;for(const e of o)s=I(e),s&&r.push(s);return r}function m(e,t,n,o){const r=l(e,t,n),s={};let i=null;for(const e of r)i=O(e,o),i&&(s[i.value]=i.keyword);return s}function h(e){let t;return(e.startsWith("A string of characters")||e.startsWith("A character string")||e.startsWith("A concatenated date-time character string"))&&(t="string"),t}function p(e){let t;return(e.startsWith("An octet-stream")||e.startsWith("A string of bytes"))&&(t="Uint8"),t}function w(e){let t;const n=[...e.matchAll(/(Signed|Unsigned) binary integer (\d{2}) bits long/g)];return 1===n.length&&3===n[0].length&&(t="Unsigned"===n[0][1]?"Ui":"I",t+="nt"+n[0][2]),t}function y(e){let t;const n=[...e.matchAll(/IEEE 754:1985 (\d{2})-bit Floating Point Number/g)];return 1===n.length&&2===n[0].length&&(t="Float"+n[0][1]),t}function b(e){let t;const n=[...e.matchAll(/A (?:stream|string) of (\d{2})-bit words/g)];return 1===n.length&&2===n[0].length&&(t="Uint"+n[0][1]),t}function E(e){let t;const n=[...e.matchAll(/(\d{2})-bit IEEE 754:1985 floating point words/g)];return 1===n.length&&2===n[0].length&&(t="Uint"+n[0][1]),t}function x(e,t,n,o){const r=l(e,t,n),s=[];let i=null;for(const e of r)i=C(e,o),i&&s.push(i);return s}function v(e,o,r){const s={};for(const l of e){const e=l.module,i=n(l.reference),c=o.querySelector(t(i));for(const t of c.childNodes)if("table"===t.nodeName){let n=e;n+=void 0===r?" Macro":" Module",n+=" Attributes",s[e]=S(t,o,n,r);break}}return s}const N={};function S(e,o,r,s){const i=l(e,o,r),c=[];let a=!1,u=!1;for(const r of i){if(0===r.length){const t=e.getElementsByTagName("caption");t&&0!==t.length?console.warn("Empty module row in: ",t[0].innerHTML):console.warn("Empty module row");continue}let l;const i=f(r[0][0]);let d=!1;if(4===r.length)l=[r];else if(i.includes("Include linkend=")){d=!0;const e=n(i);if(e.startsWith("table_")){if(!N[e]){const n=o.querySelector(t(e));N[e]=S(n,o,void 0)}l=N[e]}}else{if(!i.includes("Include one or more Functional Group Macros")){"BASIC CODED ENTRY ATTRIBUTES"!==i&&"ENHANCED ENCODING MODE"!==i&&console.warn("Unexpected row: '"+i+"'");continue}{d=!0,l=[];const e=Object.keys(s);for(const t of e)l=l.concat(s[t])}}if(i.startsWith(">")){let e=c[c.length-1];a||(e.push([]),a=!0),d||(l[0][0][0]=l[0][0][0].substring(1)),i.startsWith(">>")?(e=e[4][e[4].length-1],u||(e.push([]),u=!0)):u&&(u=!1),e[4].push(...l)}else i.startsWith(">>>")?console.warn("Not expecting a triple '>'"):(a&&(a=!1),u&&(u=!1),c.push(...l))}return c}function I(e){if(5!==e.length&&6!==e.length)throw new Error("Not the expected tag properties size: "+e.length);const t=e[0][0].split(",");return{group:t[0].substring(1,5).toString(),element:t[1].substring(0,4).toString(),keyword:void 0===e[2][0]?"":e[2][0],vr:void 0===e[3][0]?"":e[3][0],vm:void 0===e[4][0]?"":e[4][0]}}function O(e,t){if(4!==e.length&&5!==e.length)throw new Error("Not the expected UID values size: "+e.length);let n=null;return e[e.length-2][0].includes(t)&&(n={value:e[0][0],name:e[1][0],keyword:e[2][0]}),n}function C(e,t){if(3!==e.length&&4!==e.length)throw new Error("Not the expected IOD module values size: "+e.length);let n=0;4===e.length&&(n=1);const o={module:e[n][0],reference:e[n+1][0],usage:e[n+2][0]};return o.usage.startsWith("C - Required")&&(o.condition=o.usage.substring(4),o.usage="C"),"M"!==o.usage&&"C"!==o.usage&&"U"!==o.usage&&console.warn("Unexpected IOD module usage: "+o.usage),void 0!==t&&null===o.usage.match(t)?null:o}function T(e,t){const n=Object.keys(e),o={};for(const r of n){const n=[];for(const o of e[r]){const e=M(o,t);e&&n.push(e)}0!==n.length&&(o[r]=n)}return o}function M(e,t){if(4!==e.length&&5!==e.length)throw new Error("Not the expected module values size: "+e.length);const n={name:e[0][0],tag:e[1][0],type:e[2][0]};if("1"!==n.type&&"1C"!==n.type&&"2"!==n.type&&"2C"!==n.type&&"3"!==n.type&&console.warn("Unexpected module type: "+n.type),void 0!==t&&null===n.type.match(t))return null;let s="";for(let t=0;t<e[3].length;++t){const l=o(e[3][t]);if(void 0!==l.enum&&(n.enum=l.enum),0!==l.str.length){const e=r(l.str);void 0!==e.condition&&(n.condition=e.condition),0!==e.str.length&&(0!==t&&(s+=" "),s+=e.str)}}if(n.desc=s,5===e.length){n.items=[];const o=e[4];for(const e of o){const o=M(e,t);o&&n.items.push(o)}}return n}function A(e){if(!e)throw new Error("No tags.");if(0===e.length)throw new Error("Empty tags.");function t(e){return(e=(e=e.replace(/xxxxx/g,"x0004")).replace(/xxxx/g,"x001")).replace(/xx/g,"00")}const n=e.slice(),o=[];for(let e=0;e<n.length;++e){n[e].group=t(n[e].group),n[e].element=t(n[e].element);const r=n[e].group;o.includes(r)||o.push(r)}for(const e of o)"0000"!==e&&"0002"!==e&&n.push({group:e,element:"0000",keyword:"GenericGroupLength",vr:"UL",vm:"1"});var r;n.sort((r=["group","element"],function(e,t){let n=null;for(let o=0;o<r.length;++o)if(n=s(r[o])(e,t),0!==n)return n;return n}));for(let e=0;e<n.length;++e){let t=n[e].vr;void 0!==t?2!==t.length&&("See Note"===t.substring(0,8)?t="NONE":"OB or OW"===t?t="ox":"US or OW"===t?t="xx":"US or SS"===t||"US or SS or OW"===t?t="xs":console.warn("Unknown VR: '"+t+"' for "+n[e].group+","+n[e].element)):t="",n[e].vr=t}return n}function k(e){const t=Object.keys(e);for(const n of t){let t=e[n];if(t.includes("&amp;")&&(t=t.replace("&amp;","&"),e[n]=t),t.includes(":")){const o=t.indexOf(":");e[n]=t.substring(0,o)}}return e}function D(e){if(!e)throw new Error("No tags.");if(0===e.length)throw new Error("Empty tags.");const t="  ",n="'";let o="{\n",r="";for(let s=0;s<e.length;++s){const l=e[s];let i=!1;l.group!==r&&(i=!0,0!==s&&(o+="\n  },\n"),r=l.group,o+=t+n+l.group+n+": {\n");let c=i?"":",\n";c+=t+t+n+l.element+n+": ["+n+l.vr+"', "+n+l.vm+"', "+n+l.keyword+"']",o+=c}return o+="\n  }\n",o+="}\n",o}const R={2016:["a"],2018:["a"],2020:["a"],2022:["a"]},B=["03","05","06","07"];function U(){const e=Object.keys(R);e.sort(L);const t=[];for(let n=0;n<e.length;++n){const o=e[n],r=R[o];for(let e=0;e<r.length;++e)t.push(o+r[e])}return t}function L(e,t){return parseInt(t,10)-parseInt(e,10)}function q(e){const t=U(),n={};for(let o=0;o<t.length;++o)n[t[o]]={xml:W(t[o],e),html:_(t[o],e)};return n}function W(e,t){return"https://raw.githubusercontent.com/ivmartel/dcmStdToJs/main/resources/standard/"+e+"/part"+t+".xml"}function _(e,t){return"http://dicom.nema.org/medical/dicom/"+e+"/output/html/part"+t+".html"}function V(e){const t=document.getElementById("progressBar");e.lengthComputable&&(t.max=e.total,t.value=e.loaded)}function F(e){const t=document.getElementById("parseButton");0!==e.target.files.length?t.disabled=!1:t.disabled=!0}function H(t){const n=t.target;V({loaded:0,total:100,lengthComputable:!0}),n.disabled=!0,document.getElementById("output").innerHTML="";const o=new e,r=document.getElementById("fileupload");if(1===r.files.length){const e=r.files[0],t=new FileReader;t.onload=function(t){n.disabled=!1;const r=(new DOMParser).parseFromString(t.target.result,"application/xml");try{P(o.parseNode(r,e.name))}catch(e){j(e)}},t.onprogress=V,t.onloadend=V,t.onerror=function(){j("ERROR while loading data, see log for details...")},t.readAsText(e)}else{const e=document.getElementById("dicomVersions"),t=e.options[e.selectedIndex].value,r=document.getElementById("dicomParts"),s=q(r.options[r.selectedIndex].value)[t].xml,l=new XMLHttpRequest;l.open("GET",s,!0),l.responseType="document",l.overrideMimeType("text/xml"),l.onload=function(e){n.disabled=!1;try{P(o.parseNode(e.target.response,s))}catch(e){j(e)}},l.onprogress=V,l.onloadend=V,l.onerror=function(){j("ERROR while retrieving data, see log for details...")},l.send()}}function P(e){if(Array.isArray(e))for(let t=0;t<e.length;++t)J("result-"+t,e[t]);else J("result-0",e)}function j(e){console.error(e);let t=e;void 0!==e.message&&(t=e.message),J("error",t)}function J(e,t){const n=document.getElementById("output");let o="";if(void 0!==t.name){const e=document.createElement("p");let r;r=Array.isArray(t.raw)?t.raw.length:Object.keys(t.raw).length,e.appendChild(document.createTextNode(t.name+" ("+t.origin+", "+r+" items) "));const s=document.createElement("a");s.download="result.json";const l=new Blob([t.data],{type:"text/plain"});s.href=window.URL.createObjectURL(l),s.appendChild(document.createTextNode("download")),e.appendChild(s),n.appendChild(e),o=t.data}else o=t;const r=document.createElement("textarea");r.id=e,r.appendChild(document.createTextNode(o)),r.spellcheck=!1,e.includes("error")?r.className="error":r.rows=20,n.appendChild(r)}function G(e,t){const n=q(t)[e],o=document.createElement("a");o.href=n.xml,o.appendChild(document.createTextNode("xml"));const r=document.createElement("a");r.href=n.html,r.appendChild(document.createTextNode("html"));const s=document.getElementById("versionLinks");s.innerHTML="",s.appendChild(document.createTextNode("(dict: ")),s.append(o),s.appendChild(document.createTextNode(", ")),s.append(r),s.appendChild(document.createTextNode(")"))}const z=new class{setup(){document.getElementById("parseButton").addEventListener("click",H),document.getElementById("fileupload").addEventListener("change",F)}onDOMContentLoaded(){!function(){const e=document.getElementById("dicomVersions");let t=document.createElement("option");t.disabled=!0,t.selected=!0,t.text="Select a version",t.value="",e.add(t);const n=U();for(let o=0;o<n.length;++o)t=document.createElement("option"),t.text=n[o],t.value=n[o],e.add(t);const o=document.getElementById("dicomParts");let r=document.createElement("option");r.disabled=!0,r.selected=!0,r.text="Select a part",r.value="",o.add(r);const s=B;for(let e=0;e<s.length;++e)r=document.createElement("option"),r.text=s[e],r.value=s[e],o.add(r);const l=document.getElementById("parseButton");e.onchange=function(e){const t=o[o.selectedIndex].value;""!==t&&(G(e.target.value,t),l.disabled=!1)},o.onchange=function(t){const n=e[e.selectedIndex].value;""!==n&&(G(n,t.target.value),l.disabled=!1)}}()}};z.setup(),z.onDOMContentLoaded();
//# sourceMappingURL=app.bundle.js.map